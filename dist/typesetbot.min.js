"use strict";function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var s=[],n=!0,o=!1,i=void 0;try{for(var r,a=t[Symbol.iterator]();!(n=(r=a.next()).done)&&(s.push(r.value),!e||s.length!==e);n=!0);}catch(t){o=!0,i=t}finally{try{n||null==a.return||a.return()}finally{if(o)throw i}}return s}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var TypesetBot=function t(e,s){_classCallCheck(this,t),this.indexToNodes={},this.indexToTokens={},this.typeset=function(){console.log("typesettings init"),this.logger.start("Typeset"),this.typesetNodes(this.query.nodes),this.logger.end("Typeset"),this.logger.diff("Typeset"),this.logger.diff("-- Preprocess"),this.logger.diff("---- Clone working node"),this.logger.diff("---- Tokenize text"),this.logger.diff("---- Get render size of words"),this.logger.diff("------ Build HTML"),this.logger.diff("------ Update DOM"),this.logger.diff("------ Query DOM"),this.logger.diff("------ Get Properties"),this.logger.diff("---- other")},this.typesetNodes=function(t){var e=!0,s=!1,n=void 0;try{for(var o,i=t[Symbol.iterator]();!(e=(o=i.next()).done);e=!0){var r=o.value;new TypesetBotTypeset(this).typeset(r)}}catch(t){s=!0,n=t}finally{try{e||null==i.return||i.return()}finally{if(s)throw n}}},this.util=new TypesetBotUtils(this),this.settings=new TypesetBotSettings(this,s),this.logger=new TypesetBotLog(this),this.uuid=TypesetBotUtils.createUUID(),this.query=new TypesetBotElementQuery(this,e),this.typesetter=new TypesetBotTypeset(this),this.typeset()},TypesetBotLog=function t(e){_classCallCheck(this,t),this.debug=!1,this.log=function(t){this.debug&&(console.log("TypesetBot: %s",t),"object"===_typeof(t)&&console.log(t))},this.warn=function(t){this.debug&&(console.warn("TypesetBot: %s",t),"object"===_typeof(t)&&console.warn(t))},this.error=function(t){console.error("TypesetBot: %s",t),"object"===_typeof(t)&&console.error(t)},this.start=function(t){this.debug&&(t in this._performanceMap||(this._performanceMap[t]=new TypesetBotPerformanceEntry),this._performanceMap[t].start.push(performance.now()))},this.end=function(t){this.debug&&(t in this._performanceMap||(this._performanceMap[t]=new TypesetBotPerformanceEntry),this._performanceMap[t].end.push(performance.now()))},this.diff=function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.debug){var s=0,n=0,o=this._performanceMap[t];if(null!=o){for(var i=0;i<o.start.length;i++)s+=o.start[i],n+=o.end[i];var r=t+" "+(n-s).toFixed(2)+"ms --- (calls: "+o.start.length+")";return e&&this.log(r),r}}},this._tsb=e,this._performanceMap={},this.debug=this._tsb.settings.debug},TypesetBotPerformanceEntry=function t(){_classCallCheck(this,t),this.start=[],this.end=[]},TypesetBotElementQuery=function t(e,s){_classCallCheck(this,t),this.nodes=[],this._queryString=null,this._index=0,this._nodeMap={},this._nodesTemp=[],this.handleQuery=function(t){if(null!=t)if("string"!=typeof t){if("object"===_typeof(t)){if(NodeList.prototype.isPrototypeOf(t)){var e=!0,s=!1,n=void 0;try{for(var o,i=t[Symbol.iterator]();!(e=(o=i.next()).done);e=!0){var r=o.value;this._nodesTemp.push(r)}}catch(t){s=!0,n=t}finally{try{e||null==i.return||i.return()}finally{if(s)throw n}}return}if(Node.prototype.isPrototypeOf(t))return void this._nodesTemp.push(t)}this._tsb.logger.warn("Unknown type of query used.")}else{this._queryString=t;var a=document.querySelectorAll(t);if(null==a)return;var l=!0,h=!1,u=void 0;try{for(var d,c=a[Symbol.iterator]();!(l=(d=c.next()).done);l=!0){var p=d.value;this._nodesTemp.push(p)}}catch(t){h=!0,u=t}finally{try{l||null==c.return||c.return()}finally{if(h)throw u}}}},this.updateElements=function(){null!=this._queryString?this.elems=document.querySelectorAll(this._queryString):this._tsb.logger.warn("Can not update elements without a query string.")},this.indexNodes=function(t){var e=!0,s=!1,n=void 0;try{for(var o,i=t[Symbol.iterator]();!(e=(o=i.next()).done);e=!0){var r=o.value;this.indexNode(r)}}catch(t){s=!0,n=t}finally{try{e||null==i.return||i.return()}finally{if(s)throw n}}},this.indexNode=function(t){null==t.getAttribute("data-tsb-uuid")&&null==this._tsb.util.getElementIndex(t)&&(this._tsb.util.setElementIndex(t,this._index),t.setAttribute("data-tsb-uuid",this._tsb.uuid),this.nodes.push(t),this._nodeMap[this._index]=t,this._index+=1)},this._tsb=e,this.handleQuery(s),this.indexNodes(this._nodesTemp)},TypesetBotSettings=function t(e){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_classCallCheck(this,t),this._mergeSettings=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(null!=t)for(var e=0,s=Object.entries(t);e<s.length;e++){var n=_slicedToArray(s[e],2),o=n[0],i=n[1];void 0===this[o]&&this._tsb.logger.warn('Unknown settings key "'+o+'"'),this[o]=i}},this.debug=!0,this.alignment="justify",this.hyphenPenalty=50,this.hyphenPenaltyRagged=500,this.flagPenalty=3e3,this.fitnessClassDemerit=3e3,this.demeritOffset=1,this.loosenessParam=0,this.absoluteMaxRatio=5,this.maxRatio=2,this.minRatio=-1,this.hyphenLanguage="en-us",this.hyphenLeftMin=2,this.hyphenRightMin=2,this.fitnessClass=[-1,-.5,.5,1,1/0],this.spaceUnit="em",this.spaceWidth=1/3,this.spaceStretchability=1/6,this.spaceShrinkability=1/9,this.unsupportedTags=["BR","IMG"],this.ratio=function(t,e,s,n,o){return e<t?(t-e)/((s-1)*o):(t-e)/((s-1)*n)},this.badness=function(t){return null==t||t<this.minRatio?1/0:100*Math.pow(Math.abs(t),3)+.5},this.demerit=function(t,e,s){var n=s?this.flagPenalty:0;return e>=0?Math.pow(this.demeritOffset+t+e,2)+n:e===-1/0?Math.pow(this.demeritOffset+t,2)+n:Math.pow(this.demeritOffset+t,2)-Math.pow(e,2)+n},this._tsb=e,this._customSettings=s,this._mergeSettings(s)},TypesetBotUtils=function t(e){_classCallCheck(this,t),this.getElementIndex=function(t){if(null==t.getAttribute("data-tsb-indexed"))return null;var e=t.getAttribute("data-tsb-indexed"),s=parseInt(e);return isNaN(s)||s.toString()!==e?(this._tsb.logger.error('Element has attribute "data-tsb-indexed", but could not parse it.'),this._tsb.logger.error(t),null):s},this.setElementIndex=function(t,e){t.setAttribute("data-tsb-indexed",""+e)},this.getElementNodes=function(t){var e=this.getElementIndex(t);return isNaN(e)&&this._tsb.logger.error("Could not find nodes to element."),this._tsb.indexToNodes[e]},this._tsb=e};TypesetBotUtils.createUUID=function(){var t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var s=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?s:3&s|8).toString(16)})},TypesetBotUtils.isVisible=function(t){var e=t;return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)};var TypesetBotTokenizer=function t(e,s){_classCallCheck(this,t),this.tokenize=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=[];if(null==e&&(e=t),!("childNodes"in e))return[];if(!TypesetBotUtils.isVisible(e))return[];var n=!0,o=!1,i=void 0;try{for(var r,a=e.childNodes[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var l=r.value;switch(l.nodeType){case 1:s=s.concat(this.tokenizeElement(t,l));break;case 3:s=s.concat(this.tokenizeText(t,l));break;case 2:case 8:case 9:case 10:this._tsb.logger.log("Tokenizer ignores node type: "+l.nodeType),this._tsb.logger.warn(l);default:this._tsb.logger.warn("Tokenizer found unknown node type: "+l.nodeType),this._tsb.logger.warn(l)}}}catch(t){o=!0,i=t}finally{try{n||null==a.return||a.return()}finally{if(o)throw i}}return s},this.tokenizeElement=function(t,e){var s=[];if(!TypesetBotUtils.isVisible(e))return[];e.nodeName in this._tsb.settings.unsupportedTags&&(this._tsb.logger.warn("Tokenizer found unsupported node type, typesetting might not work as intended."),this._tsb.logger.warn(e));var n=this.appendToNodeMap(t,e);return s.push(new TypesetBotTag(n,e.nodeName,!1)),(s=s.concat(this.tokenize(t,e))).push(new TypesetBotTag(n,e.nodeName,!0)),s},this.tokenizeText=function(t,e){var s=[];if(3!==e.nodeType)return this._tsb.logger.warn("TokenizeText was called with wrong type: "+e.nodeType),this._tsb.logger.warn(e),[];var n=this.appendToNodeMap(t,e),o=e,i=this.replaceInvalidCharacters(o.nodeValue),r=i.split(" ");" "===i[0]&&s.push(new TypesetBotSpace(n));var a=!0,l=!1,h=void 0;try{for(var u,d=r[Symbol.iterator]();!(a=(u=d.next()).done);a=!0){var c=u.value;""!==c&&(s.push(new TypesetBotWord(n,c)),s.push(new TypesetBotSpace(n)))}}catch(t){l=!0,h=t}finally{try{a||null==d.return||d.return()}finally{if(l)throw h}}return" "!==o.nodeValue[o.nodeValue.length-1]&&s.pop(),s},this.appendToNodeMap=function(t,e){if(null==this._tsb.util.getElementIndex(t))return this._tsb.logger.error("Root node is not indexed"),this._tsb.logger.error(t),null;var s=this._tsb.util.getElementIndex(t);return s in this._tsb.indexToNodes||(this._tsb.indexToNodes[s]=[]),this._tsb.indexToNodes[s].push(e),this._tsb.indexToNodes[s].length-1},this.replaceInvalidCharacters=function(t){return t.replace(/(?:\r\n|\r|\n)/g," ")},this._tsb=e,this.typesetter=s},TypesetBotToken=function t(e,s){_classCallCheck(this,t),this.nodeIndex=e,this.type=s};TypesetBotToken.types={WORD:1,SPACE:2,TAG:3};var TypesetBotWord=function(t){function e(t,s){var n;return _classCallCheck(this,e),(n=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,t,TypesetBotToken.types.WORD))).text=s,n}return _inherits(e,TypesetBotToken),e}(),TypesetBotSpace=function(t){function e(t){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,t,TypesetBotToken.types.SPACE))}return _inherits(e,TypesetBotToken),e}(),TypesetBotTag=function(t){function e(t,s,n){var o;return _classCallCheck(this,e),(o=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,t,TypesetBotToken.types.TAG))).tag=s,o.isEndTag=n,o}return _inherits(e,TypesetBotToken),e}(),TypesetBotTypeset=function t(e){_classCallCheck(this,t),this.typeset=function(t){console.log("Typesetting:"),console.log(t),this._tsb.settings.loosenessParam=0,this._tsb.logger.start("---- Clone working node");t.cloneNode(!0);this._tsb.logger.end("---- Clone working node");this.calcLinebreaks(t)},this.calcLinebreaks=function(t){return this._tsb.logger.start("-- Preprocess"),this._tsb.logger.start("---- other"),this.render.setMinimumWordSpacing(t),this._tsb.logger.end("---- other"),this._tsb.logger.start("---- Tokenize text"),this.tokens=this.tokenizer.tokenize(t),this._tsb.logger.end("---- Tokenize text"),this._tsb.logger.start("---- other"),this.appendToTokenMap(t,this.tokens),this._tsb.logger.end("---- other"),this._tsb.logger.start("---- Get render size of words"),this.render.getWordProperties(t,this.tokens),this._tsb.logger.end("---- Get render size of words"),this._tsb.logger.end("-- Preprocess"),console.log("tokens"),console.log(this.tokens),[]},this.addBreakpoint=function(){},this.checkShortestPath=function(){return!1},this.updateShortestPath=function(){},this.appendToTokenMap=function(t,e){if(null==this._tsb.util.getElementIndex(t))return this._tsb.logger.error("Root node is not indexed"),void this._tsb.logger.error(t);var s=this._tsb.util.getElementIndex(t);this._tsb.indexToTokens[s]=e},this._tsb=e,this.render=new TypesetBotRender(e),this.tokenizer=new TypesetBotTokenizer(e,this)},TypesetBotLinebreak=function t(e){_classCallCheck(this,t),this._tsb=e},TypesetBotRender=function t(e){_classCallCheck(this,t),this.getSpaceWidth=function(t){var e=document.createElement("SPAN"),s=document.createTextNode("1"),n=document.createTextNode("1"),o=document.createTextNode(" "),i=document.createElement("SPAN");i.appendChild(o),e.appendChild(s),e.appendChild(i),e.appendChild(n),t.appendChild(e);var r=i.getBoundingClientRect(),a=r.right-r.left;return e.remove(),console.log(a),a},this.setMinimumWordSpacing=function(t){var e=this._tsb.settings.spaceWidth-this._tsb.settings.spaceShrinkability,s=this.getSpaceWidth(t);t.style.wordSpacing="calc((1px * "+e+") - "+s+"px)"},this.getWordProperties=function(t,e){console.log("Get word properties");this._tsb.util.getElementNodes(t);var s=t.innerHTML,n={},o="",i=0;this._tsb.logger.start("------ Build HTML");var r=!0,a=!1,l=void 0;try{for(var h,u=e[Symbol.iterator]();!(r=(h=u.next()).done);r=!0){var d=h.value;switch(d.type){case TypesetBotToken.types.WORD:var c=d;n[i]=d,i+=1,o+='<span class="typeset-word-node">'+c.text+"</span>";break;case TypesetBotToken.types.TAG:var p=d;o+=this.htmlGenerator.createTagHtml(t,p);break;case TypesetBotToken.types.SPACE:o+=" ";break;default:this._tsb.logger.error("Unknown token type found: "+d.type)}}}catch(t){a=!0,l=t}finally{try{r||null==u.return||u.return()}finally{if(a)throw l}}this._tsb.logger.end("------ Build HTML"),this._tsb.logger.start("------ Update DOM"),t.innerHTML=o,this._tsb.logger.end("------ Update DOM"),this._tsb.logger.start("------ Query DOM");var g=t.querySelectorAll(".typeset-word-node");this._tsb.logger.end("------ Query DOM"),this._tsb.logger.start("------ Get Properties");var f=0,y=!0,b=!1,_=void 0;try{for(var T,m=g[Symbol.iterator]();!(y=(T=m.next()).done);y=!0){var v=T.value,x=n[f];x.width=v.getBoundingClientRect().width,x.height=v.getBoundingClientRect().height,f+=1}}catch(t){b=!0,_=t}finally{try{y||null==m.return||m.return()}finally{if(b)throw _}}this._tsb.logger.end("------ Get Properties"),this._tsb.logger.start("------ Update DOM"),t.innerHTML=s,this._tsb.logger.end("------ Update DOM")},this._tsb=e,this.htmlGenerator=new TypesetBotHtml(e)},TypesetBotHtml=function t(e){_classCallCheck(this,t),this.createTagHtml=function(t,e){var s=this._tsb.util.getElementNodes(t),n=s[e.nodeIndex];if(console.log(e),console.log(s),console.log(n),e.isEndTag)return console.log("</"+n.tagName.toLowerCase()+">"),"</"+n.tagName.toLowerCase()+">";var o="",i=!0,r=!1,a=void 0;try{for(var l,h=n.attributes[Symbol.iterator]();!(i=(l=h.next()).done);i=!0){var u=l.value;o+=u.name+"="+u.value+" "}}catch(t){r=!0,a=t}finally{try{i||null==h.return||h.return()}finally{if(r)throw a}}return console.log("<"+n.tagName.toLowerCase()+" "+o+">"),"<"+n.tagName.toLowerCase()+" "+o+">"},this._tsb=e};